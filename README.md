# Counterfactual World Engine

An agentic system that reconstructs and simulates alternate realities from real-world incident artifacts using Vision Language Models (VLMs).

## Overview

The Counterfactual World Engine (CWE) uses multimodal AI to:
- **Ingest** incident data (video, logs, reports, sensor data)
- **Align** multimodal streams to a unified timeline
- **Extract** causal relationships between events
- **Simulate** "what if" counterfactual scenarios
- **Explore** hypotheses autonomously via the Marathon agent

## Quick Start

```bash
# Clone and setup
cd multiverse
python -m venv .venv
source .venv/bin/activate
pip install -e ".[dev]"

# Set up API keys
cp .env.example .env
# Edit .env with your VLM API keys

# Run example analysis
cwe analyze examples/sample_incident/

# Start API server
cwe serve --port 8000
```

## Architecture

See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) for detailed system design.

```
┌─────────────────────────────────────────────────────────────┐
│                    User Interface                            │
│              (API / CLI / Web Dashboard)                     │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Marathon Agent                            │
│         (Autonomous hypothesis exploration)                  │
└─────────────────────────────────────────────────────────────┘
                              │
┌──────────────────┬──────────────────┬───────────────────────┐
│   Counterfactual │  Causal Graph    │   Kinematic           │
│   Simulator      │  Engine          │   Simulator           │
└──────────────────┴──────────────────┴───────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  VLM Reasoning Core                          │
│        (Gemini / Grok / Claude / GPT-4)                     │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│    Temporal Alignment    │    State Management              │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   Ingestion Layer                            │
│        (Video / Logs / Reports / Sensors)                   │
└─────────────────────────────────────────────────────────────┘
```

## Project Structure

```
multiverse/
├── cwe/                    # Main package
│   ├── ingestion/          # Artifact ingestion
│   ├── alignment/          # Temporal alignment
│   ├── reasoning/          # VLM integration
│   ├── causality/          # Causal graph engine
│   ├── counterfactual/     # What-if simulation
│   ├── physics/            # Kinematic simulator
│   ├── agents/             # Marathon agent
│   ├── state/              # State management
│   ├── api/                # REST/WebSocket API
│   └── cli/                # Command-line interface
├── tests/                  # Test suite
├── examples/               # Sample incidents
├── docs/                   # Documentation
└── scripts/                # Utility scripts
```

## Key Concepts

### Incident Corpus
A collection of multimodal artifacts related to a single incident:
- Video footage (dashcam, CCTV, drone)
- System logs (timestamped events)
- Reports (PDFs, documents)
- Sensor data (GPS, accelerometer, etc.)

### Canonical Timeline
The VLM-constructed sequence of events as they actually occurred, with:
- Timestamped events
- Entity states over time
- Causal relationships
- Confidence scores

### Counterfactual
An alternate timeline generated by modifying the canonical timeline:
- Intervention: "What if X didn't happen?"
- Alternate events: How the timeline diverges
- Outcome comparison: Severity/impact differences

### Marathon Agent
An autonomous agent that:
1. Generates hypotheses about intervention points
2. Runs counterfactual simulations
3. Ranks outcomes by impact
4. Reports actionable insights

## API Example

```python
from cwe import CounterfactualEngine

# Initialize engine
engine = CounterfactualEngine(
    vlm_provider="gemini",
    api_key="your-api-key"
)

# Create incident and ingest artifacts
incident = engine.create_incident("traffic_collision_001")
incident.ingest_video("dashcam.mp4")
incident.ingest_logs("vehicle_telemetry.jsonl")
incident.ingest_report("police_report.pdf")

# Build canonical timeline
timeline = incident.build_timeline()
print(timeline.events)
print(timeline.causal_graph)

# Run counterfactual
counterfactual = incident.what_if(
    "The driver braked 2 seconds earlier"
)
print(counterfactual.alternate_timeline)
print(counterfactual.outcome_comparison)
print(counterfactual.confidence)

# Autonomous exploration
results = incident.explore(
    strategy="llm_guided",
    max_iterations=10
)
for result in results.ranked_outcomes:
    print(f"{result.intervention}: {result.outcome_score}")
```

## Configuration

```yaml
# config.yaml
vlm:
  primary_provider: gemini
  secondary_provider: claude
  ensemble_voting: true
  
context:
  max_tokens: 1000000
  summarization_strategy: hierarchical
  
simulation:
  physics_engine: kinematic_2d
  validate_trajectories: true
  
agent:
  exploration_strategy: llm_guided
  max_parallel_branches: 5
  confidence_threshold: 0.6
```

## Development

```bash
# Install dev dependencies
pip install -e ".[dev]"

# Run tests
pytest tests/

# Type checking
mypy cwe/

# Linting
ruff check cwe/

# Format code
ruff format cwe/
```

## License

Apache 2.0 - See [LICENSE](LICENSE)

## Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.
